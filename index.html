<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TokenizeArt NFT Minting</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for better aesthetics */
        .card-gradient-border {
            border-image: linear-gradient(to right, #a78bfa, #f472b6) 1;
            border-width: 2px;
            border-style: solid;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-900 to-indigo-900 text-white p-4 sm:p-8 flex items-center justify-center">

    <div class="w-full max-w-4xl bg-gray-800 bg-opacity-70 backdrop-blur-md rounded-xl shadow-2xl p-6 sm:p-10 border border-purple-700">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-center mb-6 text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-purple-600">
            TokenizeArt NFT Minting
        </h1>
        <p class="text-center text-lg text-gray-300 mb-8">
            Build your own unique Non-Fungible Token on the BNB Chain Testnet!
        </p>

        <!-- Wallet Connection Section -->
        <div class="mb-8 bg-gray-700 bg-opacity-50 border-purple-600 shadow-lg rounded-xl p-6">
            <h2 class="text-2xl text-pink-300 flex items-center justify-center gap-2 mb-4 font-semibold">
                <i data-lucide="wallet" class="h-6 w-6"></i> Connect Your Wallet
            </h2>
            <p class="text-gray-400 text-center mb-6">
                Connect your MetaMask wallet to interact with the contract.
            </p>
            <div class="flex flex-col items-center gap-4">
                <p id="account-status" class="text-green-400 text-lg break-all text-center hidden">
                    Connected: <span id="connected-account" class="font-mono"></span>
                </p>
                <button id="connect-wallet-btn" class="bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                    Connect MetaMask
                </button>
                <div id="loading-spinner" class="hidden flex items-center text-gray-300">
                    <i data-lucide="loader-2" class="mr-2 h-4 w-4 animate-spin"></i> Connecting...
                </div>
            </div>
        </div>

        <!-- Message Display -->
        <div id="message-display" class="p-4 rounded-lg mb-6 text-center text-lg font-medium hidden"></div>

        <!-- NFT Minting Form -->
        <div class="bg-gray-700 bg-opacity-50 border-purple-600 shadow-lg rounded-xl p-6">
            <h2 class="text-2xl text-pink-300 flex items-center justify-center gap-2 mb-4 font-semibold">
                <i data-lucide="image" class="h-6 w-6"></i> Mint Your NFT
            </h2>
            <p class="text-gray-400 text-center mb-6">
                Fill in the details to mint your unique digital asset.
            </p>
            <div class="space-y-6">
                <div>
                    <label for="nftName" class="block text-gray-300 text-sm font-bold mb-2">
                        NFT Name (Must include "42")
                    </label>
                    <input type="text" id="nftName" placeholder="e.g., My Awesome NFT 42"
                           class="w-full p-3 rounded-md bg-gray-800 border border-gray-600 text-white focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label for="artistName" class="block text-gray-300 text-sm font-bold mb-2">
                        Artist Name (Your login)
                    </label>
                    <input type="text" id="artistName" placeholder="e.g., your_login_42"
                           class="w-full p-3 rounded-md bg-gray-800 border border-gray-600 text-white focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label for="nftDescription" class="block text-gray-300 text-sm font-bold mb-2">
                        NFT Description
                    </label>
                    <textarea id="nftDescription" placeholder="A brief description of your NFT."
                              class="w-full p-3 rounded-md bg-gray-800 border border-gray-600 text-white focus:ring-2 focus:ring-purple-500 min-h-[100px]"></textarea>
                </div>

                <!-- Bonus Part: On-chain Inscription Toggle -->
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="onChainInscription"
                           class="h-4 w-4 rounded border-purple-500 text-purple-500 focus:ring-purple-500 bg-gray-800">
                    <label for="onChainInscription" class="text-sm font-medium text-gray-300">
                        Bonus: Store metadata and image directly on-chain (expensive for large images!)
                    </label>
                </div>

                <!-- On-chain inscription fields -->
                <div id="on-chain-fields" class="hidden space-y-4 p-4 border border-purple-500 rounded-lg bg-gray-800 bg-opacity-70">
                    <h3 class="text-xl font-semibold text-pink-300">On-Chain Inscription Details</h3>
                    <div>
                        <label for="onChainMetadataName" class="block text-gray-300 text-sm font-bold mb-2">
                            On-Chain NFT Name (e.g., My Inscribed Art 42)
                        </label>
                        <input type="text" id="onChainMetadataName" placeholder="This name will be stored directly on-chain"
                               class="w-full p-3 rounded-md bg-gray-900 border border-gray-700 text-white focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label for="onChainMetadataDescription" class="block text-gray-300 text-sm font-bold mb-2">
                            On-Chain NFT Description
                        </label>
                        <textarea id="onChainMetadataDescription" placeholder="This description will be stored directly on-chain."
                                  class="w-full p-3 rounded-md bg-gray-900 border border-gray-700 text-white focus:ring-2 focus:ring-purple-500 min-h-[80px]"></textarea>
                    </div>
                    <div>
                        <label for="onChainImageData" class="block text-gray-300 text-sm font-bold mb-2">
                            On-Chain Image Data (Base64 string - small images only!)
                        </label>
                        <textarea id="onChainImageData" placeholder="Paste Base64 encoded image data here (e.g., data:image/png;base64,iVBORw...)"
                                  class="w-full p-3 rounded-md bg-gray-900 border border-gray-700 text-white focus:ring-2 focus:ring-purple-500 min-h-[150px]"></textarea>
                        <p class="text-gray-400 text-xs mt-1">
                            For small images, you can convert them to Base64 (e.g., using an online tool) and paste here.
                            Larger images will be very expensive to store on-chain.
                        </p>
                    </div>
                </div>

                <!-- IPFS based image upload -->
                <div id="ipfs-fields">
                    <div>
                        <label for="imageUpload" class="block text-gray-300 text-sm font-bold mb-2">
                            NFT Image (Will be uploaded to IPFS conceptually)
                        </label>
                        <input type="file" id="imageUpload" accept="image/*"
                               class="w-full p-3 rounded-md bg-gray-800 border border-gray-600 text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-500 file:text-white hover:file:bg-purple-600">
                        <div id="image-preview-container" class="mt-4 flex flex-col items-center hidden">
                            <p class="text-gray-300 mb-2">Image Preview:</p>
                            <img id="image-preview" alt="NFT Preview" class="w-48 h-48 object-cover rounded-lg border border-purple-500 shadow-md">
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex justify-center pt-6">
                <button id="mint-nft-btn" disabled class="bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 text-lg">
                    Mint NFT
                </button>
                <div id="minting-spinner" class="hidden flex items-center text-gray-300 ml-4">
                    <i data-lucide="loader-2" class="mr-2 h-5 w-5 animate-spin"></i> Minting...
                </div>
            </div>
        </div>

        <!-- Minted NFT Details Section -->
        <div id="minted-nft-details" class="mt-8 bg-gray-700 bg-opacity-50 border-purple-600 shadow-lg rounded-xl p-6 hidden">
            <h2 class="text-2xl text-pink-300 flex items-center justify-center gap-2 mb-4 font-semibold">
                <i data-lucide="link" class="h-6 w-6"></i> Minted NFT Details
            </h2>
            <div class="text-center space-y-2">
                <p class="text-lg text-gray-300">
                    Your NFT (Token ID: <span id="minted-token-id" class="font-semibold text-teal-400"></span>) has been minted!
                </p>
                <p class="text-gray-400">
                    You can view it on a BSC Testnet explorer (e.g., BscScan Testnet).
                </p>
                <a id="bscscan-link" href="#" target="_blank" rel="noopener noreferrer"
                   class="inline-flex items-center gap-2 text-purple-400 hover:text-purple-300 transition-colors duration-200">
                    View on BscScan Testnet <i data-lucide="link" class="h-4 w-4"></i>
                </a>
            </div>
        </div>

        <footer class="mt-12 text-center text-gray-500 text-sm">
            <p>&copy; <span id="current-year"></span> TokenizeArt. Built for 42 project.</p>
            <p>Remember to deploy your contract to BSC Testnet and update the CONTRACT_ADDRESS in the script.</p>
        </footer>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // --- Smart Contract ABI and Address ---
        const NFT_ABI = [
            "function name() view returns (string)",
            "function symbol() view returns (string)",
            "function tokenURI(uint256 tokenId) view returns (string)",
            "function totalSupply() view returns (uint256)",
            "function ownerOf(uint256 tokenId) view returns (address)",
            "function tokenByIndex(uint256 index) view returns (uint256)",
            "function tokenOfOwnerByIndex(address owner, uint256 index) view returns (uint256)",
            "function mintNFT(address recipient, string memory _tokenURI) returns (uint256)",
            "function mintNFTOnChain(address recipient, string memory _name, string memory _description, string memory _imageData) returns (uint256)",
            "event Transfer(address indexed from, address indexed to, uint256 indexed tokenId)",
        ];

        // Replace with your deployed contract address on BSC Testnet
        const CONTRACT_ADDRESS = "0xYourDeployedContractAddressHere"; // IMPORTANT: Update this!

        // --- DOM Elements ---
        const connectWalletBtn = document.getElementById('connect-wallet-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        const accountStatus = document.getElementById('account-status');
        const connectedAccountSpan = document.getElementById('connected-account');
        const messageDisplay = document.getElementById('message-display');

        const nftNameInput = document.getElementById('nftName');
        const artistNameInput = document.getElementById('artistName');
        const nftDescriptionTextarea = document.getElementById('nftDescription');
        const onChainInscriptionCheckbox = document.getElementById('onChainInscription');
        const onChainFieldsDiv = document.getElementById('on-chain-fields');
        const ipfsFieldsDiv = document.getElementById('ipfs-fields');
        const onChainMetadataNameInput = document.getElementById('onChainMetadataName');
        const onChainMetadataDescriptionTextarea = document.getElementById('onChainMetadataDescription');
        const onChainImageDataTextarea = document.getElementById('onChainImageData');
        const imageUploadInput = document.getElementById('imageUpload');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreviewImg = document.getElementById('image-preview');
        const mintNftBtn = document.getElementById('mint-nft-btn');
        const mintingSpinner = document.getElementById('minting-spinner');

        const mintedNftDetailsDiv = document.getElementById('minted-nft-details');
        const mintedTokenIdSpan = document.getElementById('minted-token-id');
        const bscscanLink = document.getElementById('bscscan-link');

        // --- Global State ---
        let provider = null;
        let signer = null;
        let account = '';
        let contract = null;
        let imageFile = null;

        // --- Utility Functions ---
        function showMessage(message, type = 'info') {
            messageDisplay.textContent = message;
            messageDisplay.className = `p-4 rounded-lg mb-6 text-center text-lg font-medium bg-opacity-80`;
            if (type === 'success') {
                messageDisplay.classList.add('bg-green-600');
            } else if (type === 'error') {
                messageDisplay.classList.add('bg-red-600');
            } else {
                messageDisplay.classList.add('bg-blue-600');
            }
            messageDisplay.classList.remove('hidden');
            setTimeout(() => {
                messageDisplay.classList.add('hidden');
                messageDisplay.textContent = '';
            }, 5000); // Clear message after 5 seconds
        }

        function setMintButtonState() {
            if (account && (nftNameInput.value.includes('42') && artistNameInput.value.length > 0)) {
                mintNftBtn.disabled = false;
            } else {
                mintNftBtn.disabled = true;
            }
        }

        // --- Wallet Connection ---
        async function connectWallet() {
            loadingSpinner.classList.remove('hidden');
            connectWalletBtn.disabled = true;
            try {
                // Ensure ethers is available globally (e.g., loaded via a CDN script tag in the HTML)
                if (window.ethereum && window.ethers) {
                    provider = new window.ethers.providers.Web3Provider(window.ethereum);

                    // Request account access
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    account = accounts[0];

                    signer = provider.getSigner();

                    // Initialize contract instance
                    contract = new window.ethers.Contract(CONTRACT_ADDRESS, NFT_ABI, signer);

                    connectedAccountSpan.textContent = account;
                    accountStatus.classList.remove('hidden');
                    connectWalletBtn.classList.add('hidden'); // Hide connect button
                    showMessage('Wallet connected successfully!', 'success');
                } else {
                    showMessage('MetaMask or a Web3 wallet is not detected, or ethers.js is not loaded. Please ensure both are available.', 'error');
                }
            } catch (error) {
                console.error("Error connecting wallet:", error);
                showMessage(`Failed to connect wallet: ${error.message}`, 'error');
                connectWalletBtn.classList.remove('hidden'); // Show connect button again
            } finally {
                loadingSpinner.classList.add('hidden');
                connectWalletBtn.disabled = false;
                setMintButtonState();
            }
        }

        // --- Handle Account Changes ---
        function handleAccountsChanged(accounts) {
            if (accounts.length > 0) {
                account = accounts[0];
                connectedAccountSpan.textContent = account;
                accountStatus.classList.remove('hidden');
                connectWalletBtn.classList.add('hidden');
                showMessage(`Account changed to: ${account}`, 'info');
            } else {
                account = '';
                signer = null;
                contract = null;
                accountStatus.classList.add('hidden');
                connectWalletBtn.classList.remove('hidden');
                showMessage('Wallet disconnected.', 'info');
            }
            setMintButtonState();
        }

        function handleChainChanged(chainId) {
            // Reload the page or re-initialize provider/signer if chain changes
            window.location.reload();
            showMessage(`Network changed to Chain ID: ${chainId}`, 'info');
        }

        // --- Handle Image File Selection ---
        function handleImageChange(event) {
            const file = event.target.files[0];
            if (file) {
                imageFile = file;
                const reader = new FileReader();
                reader.onloadend = () => {
                    imagePreviewImg.src = reader.result;
                    imagePreviewContainer.classList.remove('hidden');
                    // If using on-chain inscription, also set the base64 data
                    if (onChainInscriptionCheckbox.checked) {
                        onChainImageDataTextarea.value = reader.result.split(',')[1]; // Get base64 part
                    }
                };
                reader.readAsDataURL(file);
            } else {
                imageFile = null;
                imagePreviewImg.src = '';
                imagePreviewContainer.classList.add('hidden');
                if (onChainInscriptionCheckbox.checked) {
                    onChainImageDataTextarea.value = '';
                }
            }
        }

        // --- Mint NFT Function ---
        async function mintNFT() {
            if (!contract || !account) {
                showMessage('Please connect your wallet first.', 'error');
                return;
            }
            if (!nftNameInput.value.includes('42')) {
                showMessage('NFT Name must include "42".', 'error');
                return;
            }
            if (!artistNameInput.value) {
                showMessage('Artist Name is required.', 'error');
                return;
            }

            mintNftBtn.disabled = true;
            mintingSpinner.classList.remove('hidden');
            mintedNftDetailsDiv.classList.add('hidden'); // Hide previous details

            try {
                let tx;
                if (onChainInscriptionCheckbox.checked) {
                    // Bonus Part: Mint with on-chain inscription
                    const onChainMetadataName = onChainMetadataNameInput.value;
                    const onChainMetadataDescription = onChainMetadataDescriptionTextarea.value;
                    const onChainImageData = onChainImageDataTextarea.value;

                    if (!onChainImageData || !onChainMetadataName || !onChainMetadataDescription) {
                        showMessage('All on-chain inscription fields are required.', 'error');
                        return;
                    }
                    showMessage('Minting NFT with on-chain inscription...', 'info');
                    tx = await contract.mintNFTOnChain(
                        account,
                        onChainMetadataName,
                        onChainMetadataDescription,
                        onChainImageData
                    );
                } else {
                    // Mandatory Part: Mint with IPFS URI
                    if (!imageFile) {
                        showMessage('Please select an image for your NFT.', 'error');
                        return;
                    }

                    showMessage('Uploading image to IPFS (conceptual)...', 'info');
                    // --- Step 1: Upload Image to IPFS (conceptual) ---
                    // In a real app, you'd use an IPFS client.
                    // const imageResult = await ipfs.add(imageFile);
                    // const imageCid = imageResult.cid.toString();
                    // const imageUrl = `ipfs://${imageCid}`;
                    // For demonstration, we'll use a placeholder URL.
                    const imageUrl = `https://placehold.co/300x300/000/FFF?text=NFT+42`; // Placeholder

                    showMessage('Creating metadata JSON...', 'info');
                    // --- Step 2: Create Metadata JSON ---
                    const metadata = {
                        name: nftNameInput.value,
                        description: nftDescriptionTextarea.value,
                        image: imageUrl,
                        artist: artistNameInput.value,
                        attributes: [
                            { trait_type: "Artist Login", value: artistNameInput.value },
                            { trait_type: "Project", value: "TokenizeArt" }
                        ]
                    };
                    const metadataString = JSON.stringify(metadata);

                    showMessage('Uploading metadata to IPFS (conceptual)...', 'info');
                    // --- Step 3: Upload Metadata to IPFS (conceptual) ---
                    // const metadataResult = await ipfs.add(metadataString);
                    // const metadataCid = metadataResult.cid.toString();
                    // const tokenURI = `ipfs://${metadataCid}`;
                    // For demonstration, we'll use a placeholder URI.
                    const tokenURI = `https://example.com/metadata/${Date.now()}.json`; // Placeholder

                    showMessage('Minting NFT...', 'info');
                    tx = await contract.mintNFT(account, tokenURI);
                }

                // Wait for the transaction to be mined
                const receipt = await tx.wait();
                console.log("Transaction Receipt:", receipt);

                // Extract token ID from the Transfer event
                const transferEvent = receipt.events?.find(e => e.event === 'Transfer');
                if (transferEvent) {
                    const tokenId = transferEvent.args.tokenId.toString();
                    mintedTokenIdSpan.textContent = tokenId;
                    bscscanLink.href = `https://testnet.bscscan.com/token/${CONTRACT_ADDRESS}?a=${tokenId}`;
                    mintedNftDetailsDiv.classList.remove('hidden');
                    showMessage(`NFT Minted Successfully! Token ID: ${tokenId}`, 'success');
                } else {
                    showMessage('NFT Minted, but could not find Token ID in events.', 'warning');
                }
            } catch (error) {
                console.error("Error minting NFT:", error);
                showMessage(`Failed to mint NFT: ${error.message}`, 'error');
            } finally {
                mintingSpinner.classList.add('hidden');
                setMintButtonState(); // Re-enable mint button based on current state
            }
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('current-year').textContent = new Date().getFullYear();

            // Check if MetaMask is available on load
            if (window.ethereum) {
                // Attempt to connect on load if already connected
                connectWallet();

                // Listen for account and chain changes
                window.ethereum.on('accountsChanged', handleAccountsChanged);
                window.ethereum.on('chainChanged', handleChainChanged);
            } else {
                showMessage('MetaMask is not detected. Please install it to use this application.', 'error');
            }
        });

        connectWalletBtn.addEventListener('click', connectWallet);
        mintNftBtn.addEventListener('click', mintNFT);
        imageUploadInput.addEventListener('change', handleImageChange);

        // Input change listeners for mint button state
        nftNameInput.addEventListener('input', setMintButtonState);
        artistNameInput.addEventListener('input', setMintButtonState);

        // Toggle on-chain inscription fields visibility
        onChainInscriptionCheckbox.addEventListener('change', () => {
            if (onChainInscriptionCheckbox.checked) {
                onChainFieldsDiv.classList.remove('hidden');
                ipfsFieldsDiv.classList.add('hidden');
                // Clear IPFS related inputs if switching to on-chain
                imageUploadInput.value = '';
                imageFile = null;
                imagePreviewImg.src = '';
                imagePreviewContainer.classList.add('hidden');
            } else {
                onChainFieldsDiv.classList.add('hidden');
                ipfsFieldsDiv.classList.remove('hidden');
                // Clear on-chain related inputs if switching to IPFS
                onChainMetadataNameInput.value = '';
                onChainMetadataDescriptionTextarea.value = '';
                onChainImageDataTextarea.value = '';
            }
        });
    </script>
    <!-- Ethers.js CDN (assuming it's loaded here for global access) -->
    <script src="https://cdn.ethers.io/5.7.2/ethers.umd.min.js"></script>
</body>
</html>